<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <title>r-world ‚Äì Pixel Art mit Google Login & Radiergummi</title>
  <style>
    body {
      margin:0; overflow:hidden; background:#f0f4f8;
      font-family: system-ui, sans-serif; color:#333;
    }
    #canvas {
      width:100vw; height:100vh; display:block;
      background:#e8f0fe; touch-action: none;
      -webkit-user-select: none;
    }
    #gui {
      position: fixed; top: 12px; left: 12px; z-index: 100;
      background: rgba(255,255,255,0.96);
      padding: 12px 16px;
      border-radius: 14px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.15);
      backdrop-filter: blur(8px);
      border: 1px solid #ddd;
      min-width: 220px;
    }
    #colors {
      display: grid;
      grid-template-columns: repeat(4, 42px);
      gap: 10px;
      margin: 12px 0 8px;
    }
    #colors button {
      width: 42px; height: 42px;
      border: 3px solid #eee;
      border-radius: 10px;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      transition: all 0.15s;
    }
    #colors button:hover { transform: scale(1.15); border-color: #bbb; }
    #colors button.selected {
      border-color: #4285f4;
      box-shadow: 0 0 0 4px rgba(66,133,244,0.3);
      transform: scale(1.1);
    }
    #profile {
      display: flex; align-items: center; gap: 10px;
      margin-bottom: 10px; font-size: 0.95rem;
    }
    #profile img {
      width: 36px; height: 36px; border-radius: 50%;
      border: 2px solid #4285f4;
    }
    #loginBtn, #logoutBtn {
      padding: 8px 14px;
      border: none; border-radius: 8px;
      cursor: pointer; font-weight: 500;
      background: #4285f4; color: white;
      margin: 6px 0;
    }
    #logoutBtn { background: #ea4335; }
    #status { font-size: 0.9rem; color: #555; min-height: 1.4em; }
  </style>
</head>
<body>

<div id="gui">
  <div id="profile">
    <img id="userPhoto" src="" alt="" style="display:none;">
    <span id="userName">Nicht angemeldet</span>
  </div>
  <button id="loginBtn">Mit Google anmelden</button>
  <button id="logoutBtn" style="display:none;">Abmelden</button>

  <div><strong>Farbe w√§hlen</strong></div>
  <div id="colors"></div>
  <div id="status">Bereit zum Malen!</div>
</div>

<canvas id="canvas"></canvas>

<script type="module">
// ===== Firebase Setup =====
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, setDoc, deleteDoc, collection, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyCXNvSbBsRVgyKJUmckxpm_WHhC6xflSTg",
  authDomain: "r-world-3879d.firebaseapp.com",
  projectId: "r-world-3879d",
  storageBucket: "r-world-3879d.appspot.com",
  messagingSenderId: "878075356607",
  appId: "1:878075356607:web:c2177f3904858d50626d0a"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

// ===== Canvas & Vars =====
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const status = document.getElementById('status');

const PIXEL = 32;
const WORLD_MIN = -300;
const WORLD_MAX = 300;

let currentColor = "#000000";
let isEraser = false;
const pixels = new Map();       // { "x_y": {color, uid} }
let user = null;

// Viewport
let scale = 1;
let offsetX = 0;
let offsetY = 0;
let isDirty = true;

// Resize
function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  isDirty = true;
}
window.addEventListener('resize', resize);
resize();

// Farbpalette
const palette = ["#000","#fff","#f00","#0f0","#00f","#ff0","#f0f","#0ff","#fa0","#0fa","#a0f","#f80","#888","#444"];
const colorDiv = document.getElementById('colors');
let colorButtons = [];

palette.forEach(c => {
  const b = document.createElement('button');
  b.style.background = c;
  b.dataset.color = c;
  b.onclick = () => {
    currentColor = c;
    isEraser = false;
    colorButtons.forEach(btn => btn.classList.remove('selected'));
    b.classList.add('selected');
  };
  colorDiv.appendChild(b);
  colorButtons.push(b);
});

// Eraser Button
const eraserBtn = document.createElement('button');
eraserBtn.style.background = 'linear-gradient(135deg, #ccc, #999)';
eraserBtn.innerHTML = 'üßº'; // oder text: 'Radierer'
eraserBtn.onclick = () => {
  isEraser = true;
  colorButtons.forEach(btn => btn.classList.remove('selected'));
  eraserBtn.classList.add('selected');
};
colorDiv.appendChild(eraserBtn);

// ===== Auth Listener =====
onAuthStateChanged(auth, u => {
  user = u;
  if (user) {
    document.getElementById('userName').textContent = user.displayName || user.email.split('@')[0];
    if (user.photoURL) {
      document.getElementById('userPhoto').src = user.photoURL;
      document.getElementById('userPhoto').style.display = 'block';
    }
    document.getElementById('loginBtn').style.display = 'none';
    document.getElementById('logoutBtn').style.display = 'block';
    status.textContent = `Hallo ${user.displayName}!`;
  } else {
    document.getElementById('userName').textContent = 'Nicht angemeldet';
    document.getElementById('userPhoto').style.display = 'none';
    document.getElementById('loginBtn').style.display = 'block';
    document.getElementById('logoutBtn').style.display = 'none';
    status.textContent = 'Melde dich an, um zu malen!';
  }
});

document.getElementById('loginBtn').onclick = () => {
  signInWithPopup(auth, provider).catch(err => {
    console.error(err);
    status.textContent = 'Login fehlgeschlagen';
  });
};

document.getElementById('logoutBtn').onclick = () => {
  signOut(auth);
};

// ===== Draw =====
function draw() {
  if (!isDirty) return requestAnimationFrame(draw);
  isDirty = false;

  ctx.setTransform(1,0,0,1,0,0);
  ctx.clearRect(0,0,canvas.width,canvas.height);

  ctx.save();
  ctx.translate(offsetX, offsetY);
  ctx.scale(scale, scale);

  // Hintergrund
  ctx.fillStyle = "#e8f0fe";
  ctx.fillRect(WORLD_MIN*PIXEL, WORLD_MIN*PIXEL, (WORLD_MAX-WORLD_MIN+1)*PIXEL, (WORLD_MAX-WORLD_MIN+1)*PIXEL);

  // Grid immer sichtbar
  ctx.strokeStyle = scale > 2 ? "#ccc" : (scale > 0.6 ? "#ddd" : "#e0e0e0");
  ctx.lineWidth = 1 / Math.max(scale, 0.3);

  const left   = -offsetX / scale;
  const top    = -offsetY / scale;
  const right  = left + canvas.width / scale;
  const bottom = top + canvas.height / scale;

  const xStart = Math.floor(left / PIXEL) * PIXEL;
  const yStart = Math.floor(top / PIXEL) * PIXEL;

  for (let x = xStart; x <= right; x += PIXEL) {
    ctx.beginPath(); ctx.moveTo(x, top); ctx.lineTo(x, bottom); ctx.stroke();
  }
  for (let y = yStart; y <= bottom; y += PIXEL) {
    ctx.beginPath(); ctx.moveTo(left, y); ctx.lineTo(right, y); ctx.stroke();
  }

  // Pixel mit Schatten
  ctx.shadowColor = "rgba(0,0,0,0.3)";
  ctx.shadowBlur = 4;
  ctx.shadowOffsetX = 2;
  ctx.shadowOffsetY = 2;

  pixels.forEach((data, key) => {
    const [px, py] = key.split('_').map(Number);
    if (px < WORLD_MIN || px > WORLD_MAX || py < WORLD_MIN || py > WORLD_MAX) return;
    ctx.fillStyle = data.color;
    ctx.fillRect(px * PIXEL + 1, py * PIXEL + 1, PIXEL - 2, PIXEL - 2);
  });

  ctx.shadowBlur = 0; // reset shadow
  ctx.restore();
  requestAnimationFrame(draw);
}
draw();

// ===== Firebase Listener =====
onSnapshot(collection(db, "pixels"), snap => {
  snap.docChanges().forEach(change => {
    const d = change.doc.data();
    const key = `${d.x}_${d.y}`;
    if (change.type === "removed") {
      pixels.delete(key);
    } else {
      pixels.set(key, {color: d.color, uid: d.uid});
    }
  });
  isDirty = true;
});

// ===== Koordinaten =====
function screenToWorld(clientX, clientY) {
  const rect = canvas.getBoundingClientRect();
  return {
    x: (clientX - rect.left - offsetX) / scale / PIXEL,
    y: (clientY - rect.top - offsetY) / scale / PIXEL
  };
}

// ===== Pixel platzieren / l√∂schen =====
function placePixel(clientX, clientY) {
  if (!user) {
    status.textContent = 'Bitte erst mit Google anmelden!';
    return;
  }

  const {x, y} = screenToWorld(clientX, clientY);
  const ix = Math.round(x);
  const iy = Math.round(y);

  if (ix < WORLD_MIN || ix > WORLD_MAX || iy < WORLD_MIN || iy > WORLD_MAX) return;

  const id = `${ix}_${iy}`;

  if (isEraser) {
    // Nur l√∂schen, wenn eigener Pixel
    if (pixels.has(id) && pixels.get(id).uid === user.uid) {
      deleteDoc(doc(db, "pixels", id)).catch(console.error);
      status.textContent = 'Pixel gel√∂scht!';
    }
  } else {
    setDoc(doc(db, "pixels", id), {
      x: ix,
      y: iy,
      color: currentColor,
      uid: user.uid,
      time: serverTimestamp()
    }, {merge: true}).catch(console.error);
  }

  isDirty = true;
}

// ===== Input Handling (Mouse + Touch) =====
let isDrawing = false;

function handleDown(e) {
  e.preventDefault();
  isDrawing = true;
  placePixel(e.clientX || e.touches[0].clientX, e.clientY || e.touches[0].clientY);
}

function handleMove(e) {
  e.preventDefault();
  if (!isDrawing) return;
  placePixel(e.clientX || e.touches[0].clientX, e.clientY || e.touches[0].clientY);
}

canvas.addEventListener('mousedown', handleDown);
canvas.addEventListener('mousemove', handleMove);
canvas.addEventListener('mouseup',   () => isDrawing = false);
canvas.addEventListener('mouseleave',() => isDrawing = false);

canvas.addEventListener('touchstart', handleDown, {passive:false});
canvas.addEventListener('touchmove',  handleMove, {passive:false});
canvas.addEventListener('touchend',   () => isDrawing = false);

// ===== Zoom (Wheel) =====
canvas.addEventListener("wheel", e => {
  e.preventDefault();
  const delta = e.deltaY < 0 ? 1.15 : 0.87;
  const oldScale = scale;
  scale *= delta;
  scale = Math.max(0.15, Math.min(25, scale));

  const mx = e.clientX - canvas.getBoundingClientRect().left;
  const my = e.clientY - canvas.getBoundingClientRect().top;

  offsetX = mx - (mx - offsetX) * (scale / oldScale);
  offsetY = my - (my - offsetY) * (scale / oldScale);

  isDirty = true;
}, {passive: false});

// Pinch-Zoom + Pan (Touch)
let lastTouches = null;

canvas.addEventListener("touchstart", e => {
  e.preventDefault();
  lastTouches = [...e.touches];
}, {passive: false});

canvas.addEventListener("touchmove", e => {
  e.preventDefault();
  const touches = e.touches;

  if (touches.length === 1 && !isDrawing) {
    // Single touch ‚Üí draw
    placePixel(touches[0].clientX, touches[0].clientY);
  }
  else if (touches.length === 2 && lastTouches?.length === 2) {
    const [t1, t2] = touches;
    const [p1, p2] = lastTouches;
    const midX = (t1.clientX + t2.clientX)/2;
    const midY = (t1.clientY + t2.clientY)/2;
    const prevMidX = (p1.clientX + p2.clientX)/2;
    const prevMidY = (p1.clientY + p2.clientY)/2;

    const distOld = Math.hypot(p2.clientX-p1.clientX, p2.clientY-p1.clientY);
    const distNew = Math.hypot(t2.clientX-t1.clientX, t2.clientY-t1.clientY);

    if (distOld > 10) {
      const zoom = distNew / distOld;
      const oldScale = scale;
      scale *= zoom ** 0.92;
      scale = Math.max(0.15, Math.min(25, scale));
      offsetX = midX - (midX - offsetX) * (scale / oldScale);
      offsetY = midY - (midY - offsetY) * (scale / oldScale);
    }

    offsetX += midX - prevMidX;
    offsetY += midY - prevMidY;

    isDirty = true;
    lastTouches = [...touches];
  }
}, {passive: false});

canvas.addEventListener("touchend", () => {
  if (e.touches.length < 2) lastTouches = null;
});

requestAnimationFrame(draw);
</script>
</body>
</html>
