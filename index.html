<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <title>Pixel World – Light Mode</title>
  <style>
    body { margin:0; overflow:hidden; background:#f8f9fc; font-family:system-ui, sans-serif; color:#333; }
    #canvas { width:100vw; height:100vh; display:block; touch-action:none; image-rendering:pixelated; background:#e8ecff; }
    #gui {
      position:fixed; top:16px; left:16px; z-index:100;
      background:rgba(255,255,255,0.96); padding:16px 20px; border-radius:16px;
      box-shadow:0 6px 24px rgba(0,0,0,0.12); border:1px solid #d0d8e8; min-width:260px;
      backdrop-filter:blur(10px);
    }
    #colors { display:grid; grid-template-columns:repeat(5, 40px); gap:10px; margin:14px 0 12px; }
    #colors button {
      width:40px; height:40px; border:2px solid #e0e0e0; border-radius:10px;
      cursor:pointer; transition:all 0.14s; box-shadow:0 2px 6px rgba(0,0,0,0.08);
    }
    #colors button:hover { transform:scale(1.14); border-color:#aaa; }
    #colors button.selected { border-color:#0066ff; box-shadow:0 0 0 3px rgba(0,102,255,0.25); }
    #status { font-size:0.96rem; margin:10px 0; color:#28a745; font-weight:500; }
    .info { font-size:0.92rem; line-height:1.5; margin-top:14px; border-top:1px solid #e0e0e0; padding-top:12px; }
  </style>
</head>
<body>
<div id="gui">
  <strong>Farbe</strong>
  <div id="colors"></div>
  <div id="status">Bereit – fang an!</div>
  <div class="info">
    <div>Verfügbare Pixel: <span id="charges">20</span>/20</div>
    <div>Platziert: <span id="placed">0</span></div>
  </div>
</div>

<canvas id="canvas"></canvas>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, setDoc, collection, onSnapshot, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyCXNvSbBsRVgyKJUmckxpm_WHhC6xflSTg",
  authDomain: "r-world-3879d.firebaseapp.com",
  projectId: "r-world-3879d",
  storageBucket: "r-world-3879d.appspot.com",
  messagingSenderId: "878075356607",
  appId: "1:878075356607:web:c2177f3904858d50626d0a"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// Vars
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const status = document.getElementById('status');
const chargesEl = document.getElementById('charges');
const placedEl = document.getElementById('placed');

const PIXEL_SIZE = 16;
let currentColor = "#000000";
let pixels = new Map();
let scale = 1;
let offsetX = 0;
let offsetY = 0;
let isDirty = true;

let charges = 20;
let placed = 0;
let uid = null; // wird später gesetzt

// Farbpalette
const palette = ["#000","#fff","#f00","#0f0","#00f","#ff0","#f0f","#0ff","#fa0","#0fa","#a0f","#f80","#c71585","#32cd32","#4169e1","#808080"];
const colorDiv = document.getElementById('colors');
palette.forEach(c => {
  const btn = document.createElement('button');
  btn.style.background = c;
  btn.onclick = () => {
    currentColor = c;
    document.querySelectorAll('#colors button').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
  };
  colorDiv.appendChild(btn);
});

// Resize + Draw (wie vorher – ich kürze es hier)
function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; isDirty = true; }
window.addEventListener('resize', resize); resize();

function draw() {
  if (!isDirty) return requestAnimationFrame(draw);
  isDirty = false;
  // ... (dein draw-Code von vorher – Hintergrund, Grid, Pixel zeichnen)
  // Kopiere den draw-Block aus deiner letzten Version hier rein, falls nötig
  requestAnimationFrame(draw);
}
draw();

// Anonymes Login – läuft im Hintergrund, blockiert nichts
signInAnonymously(auth).catch(err => {
  console.error("Anon login fehlgeschlagen:", err);
  // Nur in Console loggen – kein nerviger Status
});

onAuthStateChanged(auth, user => {
  if (user) {
    uid = user.uid;
    console.log("Angemeldet als:", uid);
    // Optional: Lade User-Daten, wenn du willst
  } else {
    console.log("Kein User (noch nicht angemeldet)");
  }
});

// Pixels live laden
onSnapshot(collection(db, "pixels"), snap => {
  snap.docChanges().forEach(ch => {
    const d = ch.doc.data();
    const key = `${d.x}_${d.y}`;
    if (ch.type === "removed") pixels.delete(key);
    else pixels.set(key, d.color);
  });
  isDirty = true;
}, err => {
  console.error("Firestore Fehler:", err);
  if (err.code === 'permission-denied') {
    status.textContent = "Keine Schreib-Rechte – check Firebase Rules!";
    status.style.color = "#dc3545";
  }
});

// Regeneration
setInterval(() => {
  if (charges < 20) {
    charges++;
    chargesEl.textContent = charges;
  }
}, 2000);

// Platzieren
async function placePixel(clientX, clientY) {
  if (charges <= 0) {
    status.textContent = "Keine Pixel mehr – warte 2s";
    status.style.color = "#dc3545";
    return;
  }

  const rect = canvas.getBoundingClientRect();
  const wx = (clientX - rect.left - offsetX) / scale / PIXEL_SIZE;
  const wy = (clientY - rect.top - offsetY) / scale / PIXEL_SIZE;
  const x = Math.round(wx);
  const y = Math.round(wy);

  const key = `${x}_${y}`;
  const pixelRef = doc(db, "pixels", key);

  try {
    await runTransaction(db, async (t) => {
      const pixelSnap = await t.get(pixelRef);
      if (pixelSnap.exists() && pixelSnap.data().owner !== uid) {
        throw new Error("fremd");
      }
      t.set(pixelRef, {
        x, y, color: currentColor, owner: uid || "local", time: serverTimestamp()
      }, {merge: true});
    });

    charges--;
    placed++;
    chargesEl.textContent = charges;
    placedEl.textContent = placed;
    status.textContent = "Platziert ✓";
    status.style.color = "#28a745";
    isDirty = true;
  } catch (e) {
    if (e.message.includes("fremd")) {
      status.textContent = "Fremdes Pixel";
    } else if (e.code === 'permission-denied') {
      status.textContent = "Keine Schreibrechte (Rules prüfen!)";
    } else {
      status.textContent = "Fehler – siehe Console";
      console.error(e);
    }
    status.style.color = "#dc3545";
  }
}

// Input Events (kopiere deinen handleDown / handleMove / wheel / pinch Code hier rein)

requestAnimationFrame(draw);
</script>
</body>
</html>
