<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>r-world iPad fix</title>
<style>
  body {
    margin: 0;
    font-family: sans-serif;
    background: #eee;
    overflow: hidden;
  }
  #ui {
    position: fixed;
    top: 10px;
    left: 10px;
    background: white;
    padding: 8px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,.2);
    z-index: 10;
  }
  #colors button {
    width: 20px;
    height: 20px;
    border: none;
    margin: 2px;
    cursor: pointer;
  }
  canvas {
    background: white;
    touch-action: none; /* wichtig f√ºr iPad */
    image-rendering: pixelated;
    display: block;
  }
</style>
</head>

<body>

<div id="ui">
  üé® Farben:
  <div id="colors"></div>
  <div>‚è±Ô∏è Cooldown: <span id="cd">0</span>s</div>
  <div>üë• Online: <span id="online">1</span></div>
</div>

<canvas id="board"></canvas>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, doc, setDoc, onSnapshot,
  collection, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// ===== FIREBASE CONFIG =====
const firebaseConfig = {
  apiKey: "AIzaSyCXNvSbBsRVgyKJUmckxpm_WHhC6xflSTg",
  authDomain: "r-world-3879d.firebaseapp.com",
  projectId: "r-world-3879d",
  storageBucket: "r-world-3879d.appspot.com",
  messagingSenderId: "878075356607",
  appId: "1:878075356607:web:c2177f3904858d50626d0a"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ===== USER-ID =====
const userId = localStorage.getItem("uid") || crypto.randomUUID();
localStorage.setItem("uid", userId);

// ===== CANVAS SETUP =====
const canvas = document.getElementById("board");
const ctx = canvas.getContext("2d");
resizeCanvas();
window.addEventListener("resize", resizeCanvas);

const PIXEL = 10;
let scale = 1;
let offsetX = 0;
let offsetY = 0;

function resizeCanvas(){
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  drawAll();
}

// ===== COLORS =====
const palette = ["#000","#f00","#0f0","#00f","#ff0","#f0f","#0ff","#fff"];
let currentColor = palette[0];
const colorDiv = document.getElementById("colors");

palette.forEach(c=>{
  const b = document.createElement("button");
  b.style.background = c;
  b.onclick = ()=> currentColor = c;
  colorDiv.appendChild(b);
});

// ===== COOLDOWN =====
const COOLDOWN = 10; // Sekunden
let lastPlace = 0;
setInterval(()=>{
  const left = Math.max(0, COOLDOWN - Math.floor((Date.now()-lastPlace)/1000));
  document.getElementById("cd").textContent = left;
}, 500);

// ===== PIXELS =====
const pixels = new Map();

// Live-Updates
onSnapshot(collection(db,"pixels"), snap=>{
  snap.docChanges().forEach(c=>{
    pixels.set(c.doc.id, c.doc.data());
  });
  drawAll();
});

// ===== DRAW FUNCTION =====
function drawAll(){
  ctx.setTransform(1,0,0,1,0,0);
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.setTransform(scale,0,0,scale,offsetX,offsetY);

  pixels.forEach(p=>{
    ctx.fillStyle = p.color;
    ctx.fillRect(p.x*PIXEL, p.y*PIXEL, PIXEL, PIXEL);
  });
}

// ===== PLACE PIXEL =====
function placePixel(clientX, clientY){
  if(Date.now() - lastPlace < COOLDOWN*1000) return;
  const x = Math.floor((clientX - offsetX) / (PIXEL*scale));
  const y = Math.floor((clientY - offsetY) / (PIXEL*scale));
  const id = `${x}_${y}`;
  setDoc(doc(db,"pixels",id),{
    x, y, color: currentColor, time: serverTimestamp()
  });
  lastPlace = Date.now();
}

// ===== TOUCH EVENTS (iPad) =====
let lastPanX=0, lastPanY=0;

canvas.addEventListener("touchstart", e=>{
  e.preventDefault(); // wichtig f√ºr iPad
  if(e.touches.length===1){
    const t = e.touches[0];
    placePixel(t.clientX, t.clientY);
  } else if(e.touches.length===2){
    const t1 = e.touches[0];
    const t2 = e.touches[1];
    lastPanX = (t1.clientX + t2.clientX)/2;
    lastPanY = (t1.clientY + t2.clientY)/2;
  }
});

canvas.addEventListener("touchmove", e=>{
  e.preventDefault();
  if(e.touches.length===2){
    const t1 = e.touches[0];
    const t2 = e.touches[1];
    const cx = (t1.clientX + t2.clientX)/2;
    const cy = (t1.clientY + t2.clientY)/2;
    offsetX += cx - lastPanX;
    offsetY += cy - lastPanY;
    lastPanX = cx;
    lastPanY = cy;
    drawAll();
  }
});

// ===== MOUSE EVENTS =====
canvas.addEventListener("pointerdown", e=>{
  if(e.pointerType!=="touch") placePixel(e.clientX,e.clientY);
});

canvas.addEventListener("wheel", e=>{
  e.preventDefault();
  scale *= e.deltaY<0 ? 1.1 : 0.9;
  drawAll();
},{passive:false});

// ===== ONLINE USERS =====
const meRef = doc(db,"online",userId);
setDoc(meRef,{time:serverTimestamp()});
setInterval(()=>setDoc(meRef,{time:serverTimestamp()}),10000);

onSnapshot(collection(db,"online"), snap=>{
  document.getElementById("online").textContent = snap.size;
});

console.log("r-world iPad fix FULL l√§uft ‚úÖ");
</script>

</body>
</html>
